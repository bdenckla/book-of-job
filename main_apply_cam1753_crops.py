# Initially generated by GitHub Copilot.
"""
Apply cam1753 word crops from exported editor JSON.

Reads the bbox JSON exported by the cam1753 crop editor (from clipboard
or .novc/cam1753_crops_export.json), crops each word from the full-resolution
page image, and saves to docs/jobn/img/cam1753-{sid}.png.

Usage:
    .venv\\Scripts\\python.exe main_apply_cam1753_crops.py .novc/cam1753_crops_export.json
"""

import json
import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent

# Add sibling repo to sys.path
CAM1753_REPO = ROOT.parent / "codex-index-cam1753"
sys.path.insert(0, str(CAM1753_REPO))

from py_cam1753_word_image.page import load_page_image

OUT_DIR = ROOT / "docs" / "jobn" / "img"


def main():
    if len(sys.argv) < 2:
        print("Usage: main_apply_cam1753_crops.py <json_file>")
        print("  The JSON file should contain the array exported by the crop editor.")
        sys.exit(1)

    json_path = Path(sys.argv[1])
    if not json_path.exists():
        print(f"File not found: {json_path}")
        sys.exit(1)

    crops = json.loads(json_path.read_text("utf-8"))
    print(f"Applying {len(crops)} crops...")

    # Cache page images (they can be large)
    page_cache = {}
    saved = 0
    for crop in crops:
        sid = crop["sid"]
        page_id = crop["page"]
        bb = crop["bbox_abs"]
        x, y, w, h = bb["x"], bb["y"], bb["w"], bb["h"]

        if page_id not in page_cache:
            print(f"  Loading page {page_id}...")
            page_cache[page_id] = load_page_image(page_id)

        img = page_cache[page_id]
        cropped = img.crop((x, y, x + w, y + h))

        out_path = OUT_DIR / f"cam1753-{sid}.png"
        cropped.save(out_path)
        print(f"  {out_path.name}: {cropped.size[0]}\u00d7{cropped.size[1]}")
        saved += 1

    print(f"Done. {saved} images saved to {OUT_DIR}")


if __name__ == "__main__":
    main()
