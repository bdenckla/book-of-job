<!-- Initially generated by GitHub Copilot. -->
# Procedure: Generating Cambridge MS Add. 1753 Word Crops for Quirkrecs

This describes the workflow for supplying μC (Cambridge MS Add. 1753)
word-level image crops to quirkrecs that lack them. It uses page images
and line-break data from the sibling `codex-index-cam1753` repo.

## Copilot quick-start

When the user says **"let\u2019s do the next batch of Cambridge crops"**
(or similar), follow this exact sequence. Do NOT manually query
`enriched-quirkrecs.json` or try to compute missing SIDs yourself —
the scripts handle that automatically.

1. **Check progress** (optional, if user asks how much is left):
   ```powershell
   .venv\Scripts\python.exe main_gen_cam1753_crop_editor.py --status
   ```
2. **Generate crop editor** (picks the next N missing SIDs automatically):
   ```powershell
   .venv\Scripts\python.exe main_gen_cam1753_crop_editor.py --batch 10
   ```
   The script prints which SIDs it selected. The editor HTML opens
   automatically in the browser.
3. **Tell the user** which SIDs/verses are in the batch (from the
   script output) and ask them to adjust bounding boxes and paste the
   Export JSON.
4. **When user pastes JSON**, save to `.novc/cam1753_crops_export.json`
   and run:
   ```powershell
   .venv\Scripts\python.exe main_apply_cam1753_crops.py .novc\cam1753_crops_export.json
   ```
5. **Rebuild HTML:**
   ```powershell
   .venv\Scripts\python.exe main_gen_misc_authored_english_documents.py
   ```
6. **Open detail pages** for visual confirmation:
   ```powershell
   $sids = @("SID1","SID2","SID3")   # from step 2 output
   foreach ($s in $sids) {
       Start-Process "C:\Users\BenDe\GitRepos\book-of-job\docs\jobn-details\$s.html"
       Start-Sleep -Milliseconds 500
   }
   ```
7. **Clean `.novc/`** after user confirms:
   ```powershell
   Get-ChildItem ".novc" -File | Remove-Item -Force
   ```

**That\u2019s it.** Steps 2-3 are all that\u2019s needed to start a batch.

## Overview

Each quirkrec that is missing a cam1753 image needs a cropped PNG of the
relevant word from the Cambridge manuscript. The workflow is:

1. **Generate crop editor** → interactive HTML with draggable bounding
   boxes overlaid on the manuscript image
2. **User adjusts** → drag/nudge boxes to tightly frame each word
3. **Export JSON** → user clicks Export, copies bbox coordinates
4. **Paste JSON into chat** → assistant saves to `.novc/cam1753_crops_export.json`
5. **Apply crops** → crop from full-resolution page images, save PNGs
6. **Rebuild HTML** → regenerate output docs
7. **Show in browser** → open detail pages to visually confirm

## Scripts

### `main_gen_cam1753_crop_editor.py`

Generates an interactive HTML crop editor at `.novc/cam1753_crop_editor.html`.

```powershell
.venv\Scripts\python.exe main_gen_cam1753_crop_editor.py --status       # progress summary
.venv\Scripts\python.exe main_gen_cam1753_crop_editor.py                # first 6 missing
.venv\Scripts\python.exe main_gen_cam1753_crop_editor.py --batch 10     # next 10 missing
.venv\Scripts\python.exe main_gen_cam1753_crop_editor.py --all          # all missing
.venv\Scripts\python.exe main_gen_cam1753_crop_editor.py 1613 1620      # specific SIDs
```

### `main_apply_cam1753_crops.py`

Applies crop bounding boxes from the editor export JSON to produce final PNGs.

```powershell
.venv\Scripts\python.exe main_apply_cam1753_crops.py .novc\cam1753_crops_export.json
```

This:
- Crops each word from the full-resolution page image
- Saves PNGs to `docs/jobn/img/cam1753/cam1753-{sid}.png`
- Embeds tEXt metadata in each PNG for reproducibility
- Appends entries to `out/cam1753-crops.json` (persistent crop record)

## Batch workflow (step by step)

Process quirkrecs in batches of ~10:

1. **Generate crop editor:**
   ```powershell
   .venv\Scripts\python.exe main_gen_cam1753_crop_editor.py --batch 10
   ```
   The editor HTML opens automatically in the browser.

2. **Adjust bounding boxes** in the editor, then click **Export JSON**.

3. **Paste the JSON** into the chat. The assistant saves it to
   `.novc/cam1753_crops_export.json` and runs:
   ```powershell
   .venv\Scripts\python.exe main_apply_cam1753_crops.py .novc\cam1753_crops_export.json
   ```

4. **Rebuild HTML:**
   ```powershell
   .venv\Scripts\python.exe main_gen_misc_authored_english_documents.py
   ```

5. **Show detail pages in browser** — open each detail page directly
   as a local file (no server needed):
   ```powershell
   $sids = @("SID1","SID2","SID3")
   foreach ($s in $sids) {
       Start-Process "C:\Users\BenDe\GitRepos\book-of-job\docs\jobn-details\$s.html"
       Start-Sleep -Milliseconds 500
   }
   ```
   Detail pages are named `{SID}.html` in `docs/jobn-details/`.

6. **Clean `.novc/`** after confirming the crops look good:
   ```powershell
   Get-ChildItem ".novc" -File | Remove-Item -Force
   ```

7. **Commit** when satisfied.

## Image naming convention

- `cam1753-{short_id}.png` where `short_id` = `CCVV` or compound SID
- Saved to `docs/jobn/img/cam1753/`

## Key data files

- `out/cam1753-crops.json` — persistent JSON record of all crop
  coordinates, keyed by SID. Stores enough data to reproduce any crop.
- Page images in `codex-index-cam1753/cam1753-pages/` — full-resolution
  JPEG source images.
- Line-break data in `codex-index-cam1753/cam1753-line-breaks/` — used
  by the editor to locate words on manuscript pages.
